# 实施计划

- [x] 1. 项目初始化和基础设施搭建
  - 创建项目目录结构
  - 配置 TypeScript、Webpack 和开发环境
  - 设置测试框架（Jest + fast-check）
  - 创建基本的 HTML 页面结构和 CSS 样式
  - _需求：9.1, 9.2_

- [x] 2. 实现摄像头管理模块
  - 实现 CameraManager 类，处理摄像头权限请求和视频流获取
  - 实现错误处理（权限拒绝、设备未找到、初始化失败）
  - 在 UI 中显示视频流
  - _需求：1.1, 1.2, 1.4, 1.5_

- [x] 2.1 编写 CameraManager 单元测试
  - 测试权限请求流程
  - 测试错误处理逻辑
  - 测试资源释放
  - _需求：1.1, 1.2, 1.4, 1.5_

- [x] 3. 实现帧处理模块
  - 实现 FrameProcessor 类，从视频流提取帧
  - 实现 ImageData 到 Canvas 的转换
  - 实现 ImageData 到 Tensor 的转换（用于 TensorFlow.js）
  - 实现帧率监控功能
  - _需求：1.3_

- [x] 3.1 编写 FrameProcessor 单元测试
  - 测试帧提取功能
  - 测试格式转换
  - 测试帧率计算
  - _需求：1.3_

- [x] 4. 集成人脸检测模型
  - 集成 MediaPipe Face Mesh 或 face-api.js
  - 实现 FaceDetector 类，加载和初始化模型
  - 实现人脸检测功能，返回人脸边界框
  - 处理多人脸场景，选择最大或最中心的人脸
  - _需求：2.1, 2.2, 2.4_

- [x] 4.1 编写人脸检测属性测试
  - **属性 2：持续跟踪一致性**
  - **验证：需求 2.2**

- [x] 4.2 编写多人脸选择属性测试
  - **属性 3：多人脸选择一致性**
  - **验证：需求 2.4**

- [x] 5. 实现眼部关键点检测
  - 实现 EyeDetector 类，基于人脸检测结果定位双眼
  - 提取左右眼瞳孔中心点坐标
  - 实现持续跟踪和坐标更新
  - _需求：3.1, 3.2, 3.3_

- [x] 5.1 编写眼部坐标更新属性测试
  - **属性 4：眼部坐标持续更新**
  - **验证：需求 3.3**

- [ ] 6. 实现距离计算模块
  - 实现 DistanceCalculator 类
  - 实现欧几里得距离计算函数
  - 实现瞳距换算函数（像素到毫米）
  - 实现结果验证（合理性检查）
  - _需求：4.1, 4.2, 6.1_

- [ ] 6.1 编写距离计算属性测试
  - **属性 1：欧几里得距离计算正确性**
  - **验证：需求 4.1**

- [ ] 6.2 编写像素距离实时计算属性测试
  - **属性 5：像素距离实时计算**
  - **验证：需求 4.2**

- [ ] 6.3 编写瞳距换算属性测试
  - **属性 9：瞳距换算公式正确性**
  - **验证：需求 6.1**

- [ ] 7. 实现数据平滑模块
  - 实现 DataSmoother 类
  - 实现滑动窗口平均算法
  - 实现异常值检测和过滤（Z-score 方法）
  - 应用平滑算法到像素距离和瞳距数据
  - _需求：4.3, 10.1, 10.2, 10.3_

- [ ] 7.1 编写数据平滑属性测试
  - **属性 6：数据平滑减少波动**
  - **验证：需求 4.3**

- [ ] 7.2 编写平滑算法应用属性测试
  - **属性 13：平滑算法应用一致性**
  - **验证：需求 10.1**

- [ ] 7.3 编写异常值排除属性测试
  - **属性 14：异常值排除正确性**
  - **验证：需求 10.3**

- [ ] 8. 实现卡片检测模块
  - 集成 OpenCV.js 或实现自定义卡片检测算法
  - 实现 CardDetector 类
  - 实现轮廓检测和圆角矩形识别
  - 实现宽高比验证（1.586 ± 10%）
  - 计算卡片像素宽度
  - 实现卡片姿态检查（倾斜角度）
  - _需求：5.1, 5.2, 5.3, 5.5_

- [ ] 8.1 编写卡片宽高比验证属性测试
  - **属性 7：卡片宽高比验证**
  - **验证：需求 5.2**

- [ ] 8.2 编写卡片像素宽度计算属性测试
  - **属性 8：卡片像素宽度计算**
  - **验证：需求 5.3**

- [ ] 9. 实现可视化渲染模块
  - 实现 VisualizationRenderer 类
  - 实现人脸边界框绘制
  - 实现眼部中心点标记绘制
  - 实现眼部连线绘制
  - 实现卡片轮廓绘制
  - 实现调试模式切换
  - _需求：3.4, 8.1, 8.2, 8.3, 8.4_

- [ ] 10. 实现测量控制器
  - 实现 MeasurementController 类
  - 实现状态机（INITIALIZING → WAITING_FOR_FACE → FACE_DETECTED → WAITING_FOR_CARD → MEASURING → MEASUREMENT_COMPLETE）
  - 协调各模块的工作流程
  - 实现测量循环（帧提取 → 检测 → 计算 → 平滑 → 更新）
  - 实现错误处理和状态转换
  - _需求：2.3, 5.4, 7.1, 7.2, 7.3_

- [ ] 10.1 编写状态提示映射属性测试
  - **属性 11：状态提示映射完整性**
  - **验证：需求 7.1**

- [ ] 10.2 编写错误指导属性测试
  - **属性 12：错误指导完整性**
  - **验证：需求 7.4**

- [ ] 11. 实现用户界面管理器
  - 实现 UIManager 类
  - 实现状态提示显示（根据测量状态）
  - 实现瞳距结果显示（大字号、毫米单位、免责声明）
  - 实现调试信息面板（FPS、坐标、像素距离等）
  - 实现加载状态和进度显示
  - _需求：6.3, 6.4, 7.1, 7.2, 7.3, 8.5_

- [ ] 11.1 编写瞳距显示更新属性测试
  - **属性 10：瞳距显示实时更新**
  - **验证：需求 6.5**

- [ ] 12. 集成所有模块并实现主应用
  - 创建主应用入口（main.ts）
  - 初始化所有模块
  - 连接 MeasurementController 和 UIManager
  - 实现完整的测量流程
  - 处理应用生命周期（初始化、运行、清理）
  - _需求：所有需求_

- [ ] 13. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 14. 优化性能和用户体验
  - 优化帧处理频率
  - 启用 WebGL 加速
  - 优化模型加载（显示进度、预加载）
  - 优化内存使用（及时释放资源）
  - 改进 UI 交互和视觉反馈
  - _需求：1.3, 9.5_

- [ ] 14.1 进行性能测试
  - 测试帧率（目标 ≥ 20 FPS）
  - 测试初始化时间（目标 < 5s）
  - 测试内存使用
  - 测试长时间运行稳定性
  - _需求：1.3, 9.5_

- [ ] 15. 浏览器兼容性测试和修复
  - 实现浏览器支持检测
  - 在 Chrome、Firefox、Safari、Edge 中测试
  - 修复兼容性问题
  - 添加降级处理和 polyfills
  - _需求：9.1_

- [ ] 16. 部署准备
  - 配置生产环境构建
  - 优化资源加载（代码分割、压缩）
  - 配置 HTTPS
  - 准备部署文档
  - _需求：9.3_

- [ ] 17. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
