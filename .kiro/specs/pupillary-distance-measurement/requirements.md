# 需求文档

## 简介

本项目旨在构建一个纯浏览器端运行的视觉测量系统，通过调用设备摄像头采集用户人脸画面，结合人脸关键点检测与标准尺寸圆角矩形卡片作为尺度参照物，实时计算并展示用户瞳距（Interpupillary Distance, IPD）。系统不依赖专用硬件，不要求安装 App，目标是在普通消费级设备条件下，提供可重复、可解释的近似瞳距测量结果。

## 术语表

- **测量系统（Measurement System）**：基于浏览器的瞳距测量应用程序
- **用户（User）**：使用测量系统测量瞳距的个人
- **摄像头流（Camera Stream）**：从设备摄像头获取的实时视频流
- **人脸检测器（Face Detector）**：检测视频流中人脸的算法组件
- **瞳孔中心点（Pupil Center Point）**：左眼或右眼瞳孔的中心像素坐标
- **标准卡片（Reference Card）**：符合 ISO/IEC 7810 ID-1 标准的圆角矩形卡片（85.60mm × 53.98mm）
- **卡片检测器（Card Detector）**：识别视频流中标准卡片的算法组件
- **瞳距（IPD, Interpupillary Distance）**：双眼瞳孔中心点之间的物理距离，以毫米为单位
- **像素距离（Pixel Distance）**：图像坐标系中两点之间的欧几里得距离
- **换算比例（Scale Ratio）**：像素距离与物理距离之间的转换系数

## 需求

### 需求 1：摄像头访问与视频流展示

**用户故事：** 作为用户，我希望系统能够访问我的设备摄像头并实时显示视频画面，以便我可以看到自己的人脸进行测量。

#### 验收标准

1. WHEN 用户首次访问测量页面 THEN 测量系统 SHALL 请求摄像头访问权限
2. WHEN 用户授予摄像头权限 THEN 测量系统 SHALL 在页面中显示实时视频流
3. WHILE 摄像头流处于活动状态 THEN 测量系统 SHALL 保持帧率不低于 20 FPS
4. IF 用户拒绝摄像头权限 THEN 测量系统 SHALL 显示明确的错误提示信息
5. WHEN 摄像头流初始化失败 THEN 测量系统 SHALL 向用户显示故障原因

### 需求 2：人脸检测

**用户故事：** 作为用户，我希望系统能够自动检测我的人脸，以便系统知道在哪里寻找我的眼睛。

#### 验收标准

1. WHEN 视频流中出现单一正面人脸 THEN 测量系统 SHALL 检测并定位该人脸
2. WHILE 人脸保持在视频流中 THEN 测量系统 SHALL 在连续帧中持续跟踪该人脸
3. WHEN 视频流中未检测到人脸 THEN 测量系统 SHALL 显示提示"请正对摄像头"
4. WHEN 视频流中检测到多个人脸 THEN 测量系统 SHALL 仅处理最大或最中心的人脸
5. WHILE 人脸检测处于活动状态 THEN 测量系统 SHALL 在正常光照条件下保持检测成功率不低于 95%

### 需求 3：双眼瞳孔中心点检测

**用户故事：** 作为用户，我希望系统能够精确定位我的双眼瞳孔中心，以便系统可以计算我的瞳距。

#### 验收标准

1. WHEN 人脸检测器成功定位人脸 THEN 测量系统 SHALL 检测左眼瞳孔中心点坐标 (xL, yL)
2. WHEN 人脸检测器成功定位人脸 THEN 测量系统 SHALL 检测右眼瞳孔中心点坐标 (xR, yR)
3. WHILE 双眼保持在视频流中 THEN 测量系统 SHALL 在连续帧中持续更新瞳孔中心点坐标
4. WHEN 瞳孔中心点被检测到 THEN 测量系统 SHALL 在视频流上叠加可视化标记
5. WHILE 瞳孔检测处于活动状态 THEN 测量系统 SHALL 在正常光照条件下保持检测成功率不低于 95%

### 需求 4：双眼像素距离计算

**用户故事：** 作为用户，我希望系统能够计算我双眼之间的像素距离，以便为后续的物理距离换算提供基础。

#### 验收标准

1. WHEN 左右眼瞳孔中心点坐标均可用 THEN 测量系统 SHALL 计算欧几里得像素距离 D_eye_px = sqrt((xR - xL)² + (yR - yL)²)
2. WHILE 瞳孔中心点持续更新 THEN 测量系统 SHALL 实时重新计算像素距离
3. WHEN 像素距离在连续帧间波动 THEN 测量系统 SHALL 应用平滑算法以减少抖动
4. WHERE 调试模式已启用 THEN 测量系统 SHALL 在页面中显示当前像素距离数值
5. WHILE 计算处于活动状态 THEN 测量系统 SHALL 确保计算延迟不超过 50 毫秒

### 需求 5：标准卡片检测

**用户故事：** 作为用户，我希望系统能够识别我放置在额头的标准卡片，以便系统可以建立像素到物理距离的换算关系。

#### 验收标准

1. WHEN 视频流中出现符合 ISO/IEC 7810 ID-1 标准的圆角矩形卡片 THEN 卡片检测器 SHALL 识别该卡片轮廓
2. WHEN 卡片检测器识别卡片 THEN 测量系统 SHALL 验证卡片宽高比接近 1.586（误差范围 ±10%）
3. WHEN 卡片被成功识别 THEN 测量系统 SHALL 计算卡片的像素宽度 W_card_px
4. WHEN 视频流中未检测到卡片 THEN 测量系统 SHALL 显示提示"请放置标准卡片"
5. WHEN 卡片姿态异常（倾斜角度超过 15 度）THEN 测量系统 SHALL 显示提示"请保持卡片与脸部平行"
6. WHILE 卡片保持正对摄像头 THEN 测量系统 SHALL 保持卡片识别稳定性不低于 90%

### 需求 6：瞳距换算与展示

**用户故事：** 作为用户，我希望系统能够将像素距离转换为实际的毫米级瞳距，并清晰地展示给我，以便我了解我的瞳距测量结果。

#### 验收标准

1. WHEN 双眼像素距离和卡片像素宽度均可用 THEN 测量系统 SHALL 计算瞳距 IPD_mm = (D_eye_px / W_card_px) × 85.60
2. WHILE 测量条件保持稳定 THEN 测量系统 SHALL 确保瞳距数值在 5 秒内波动不超过 ±2 毫米
3. WHEN 瞳距计算完成 THEN 测量系统 SHALL 在页面中以毫米为单位显示瞳距数值
4. WHEN 显示瞳距结果 THEN 测量系统 SHALL 标注"测量结果为近似值"
5. WHILE 测量处于活动状态 THEN 测量系统 SHALL 实时更新瞳距显示

### 需求 7：用户交互与状态提示

**用户故事：** 作为用户，我希望系统能够清晰地告诉我当前的测量状态和需要采取的操作，以便我能够正确完成测量流程。

#### 验收标准

1. WHEN 测量系统状态发生变化 THEN 测量系统 SHALL 显示对应的状态提示信息
2. WHEN 所有测量条件满足 THEN 测量系统 SHALL 显示"测量中"状态
3. WHEN 测量完成且结果稳定 THEN 测量系统 SHALL 显示"测量完成"状态
4. WHILE 用户操作不当 THEN 测量系统 SHALL 提供明确的纠正指导
5. WHEN 用户完成一次测量 THEN 测量系统 SHALL 允许用户在 60 秒内完成整个流程

### 需求 8：调试与可视化功能

**用户故事：** 作为开发者或高级用户，我希望能够查看系统的检测过程和中间数据，以便我可以理解系统的工作原理和诊断问题。

#### 验收标准

1. WHERE 调试模式已启用 THEN 测量系统 SHALL 在视频流上叠加检测点、线和框
2. WHERE 调试模式已启用 THEN 测量系统 SHALL 显示瞳孔中心点坐标
3. WHERE 调试模式已启用 THEN 测量系统 SHALL 显示卡片轮廓和像素宽度
4. WHEN 用户切换调试模式 THEN 测量系统 SHALL 立即更新可视化叠加层
5. WHERE 调试模式已启用 THEN 测量系统 SHALL 显示当前帧率信息

### 需求 9：浏览器兼容性与部署

**用户故事：** 作为用户，我希望能够在主流浏览器中使用该系统，而无需安装任何额外软件，以便我可以方便地进行测量。

#### 验收标准

1. THE 测量系统 SHALL 在 Chrome、Firefox、Safari 和 Edge 最新版本中正常运行
2. THE 测量系统 SHALL 完全在浏览器端执行所有计算
3. WHEN 系统部署到生产环境 THEN 测量系统 SHALL 通过 HTTPS 协议提供服务
4. THE 测量系统 SHALL 不依赖后端服务器进行核心测量计算
5. WHEN 用户访问系统 THEN 测量系统 SHALL 在 5 秒内完成初始化加载

### 需求 10：数据处理与平滑

**用户故事：** 作为用户，我希望测量结果稳定可靠，不会因为轻微的头部移动或检测抖动而剧烈波动，以便我能够获得可信的测量值。

#### 验收标准

1. WHEN 检测数据在连续帧间波动 THEN 测量系统 SHALL 应用时间平滑算法
2. WHILE 平滑算法处于活动状态 THEN 测量系统 SHALL 使用滑动窗口大小不少于 5 帧
3. WHEN 检测到异常值（偏离均值超过 3 个标准差）THEN 测量系统 SHALL 排除该数据点
4. WHILE 用户姿态稳定 THEN 测量系统 SHALL 确保平滑后的瞳距波动不超过 ±1 毫米
5. WHEN 用户姿态发生显著变化 THEN 测量系统 SHALL 在 500 毫秒内响应并更新测量结果
